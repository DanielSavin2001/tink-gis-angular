{"version":3,"sources":["../../../src/scripts/services/themeService.js"],"names":[],"mappings":"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","file":"themeService.js","sourcesContent":["'use strict';\r\n(function () {\r\n    var module = angular.module('tink.gis');\r\n    var service = function (map, ThemeHelper, MapData, LayerManagementService) {\r\n        var _service = {};\r\n        _service.AddAndUpdateThemes = function (themesBatch) {\r\n            console.log('Themes batch for add and updates...');\r\n            console.log(themesBatch);\r\n            themesBatch.forEach(theme => {\r\n                var existingTheme = MapData.Themes.find(x => { return x.CleanUrl == theme.CleanUrl });\r\n                console.log(theme);\r\n                console.log(theme.status);\r\n                switch (theme.status) {\r\n                    case ThemeStatus.NEW:\r\n                        if (theme.Type == ThemeType.ESRI) {\r\n                            LayerManagementService.SetAditionalLayerInfo(theme);\r\n                        }\r\n                        _service.AddNewTheme(theme);\r\n                        break;\r\n                    case ThemeStatus.DELETED:\r\n                        _service.DeleteTheme(existingTheme);\r\n                        break;\r\n                    case ThemeStatus.UNMODIFIED:\r\n                        // niets doen niets veranderd!\r\n                        break;\r\n                    case ThemeStatus.UPDATED:\r\n                        _service.UpdateTheme(theme, existingTheme);\r\n                        _service.UpdateThemeVisibleLayers(existingTheme);\r\n                        break;\r\n                    default:\r\n                        console.log('Er is iets fout, status niet bekend!!!: ' + theme.status);\r\n                        break;\r\n                }\r\n                //Theme is proccessed, now make it unmodified again\r\n                theme.status = ThemeStatus.UNMODIFIED;\r\n\r\n\r\n            });\r\n            console.log('refresh of sortableThemes');\r\n            $('#sortableThemes').sortable('refresh');\r\n\r\n            MapData.SetZIndexes();\r\n        };\r\n        _service.UpdateThemeVisibleLayers = function (theme) {\r\n            theme.UpdateMap();\r\n        };\r\n        _service.UpdateTheme = function (updatedTheme, existingTheme) {\r\n            //lets update the existingTheme\r\n            for (var x = 0; x < updatedTheme.AllLayers.length; x++) {\r\n                var updatedLayer = updatedTheme.AllLayers[x];\r\n                var existingLayer = existingTheme.AllLayers[x];\r\n\r\n                //laten we alle Visible Layers nu terug toevoegen meteen juiste ref etc uit de geupdate theme.\r\n                if (updatedLayer.enabled && updatedLayer.visible) {\r\n                    //eerst checken dat ze nog niet bestaan!.\r\n                    if (existingTheme.Type == ThemeType.ESRI && MapData.VisibleLayers.indexOf(existingLayer) == -1) {\r\n                        MapData.VisibleLayers.push(existingLayer);\r\n                    }\r\n                    if (existingTheme.VisibleLayers.indexOf(existingLayer) == -1) {\r\n                        existingTheme.VisibleLayers.push(existingLayer);\r\n                    }\r\n                }\r\n                else {\r\n                    //Anders halen we hem ook moest hij bij VisLayers aanwezig zijn er van af!\r\n                    if (existingTheme.Type == ThemeType.ESRI && MapData.VisibleLayers.indexOf(existingLayer) != -1) {\r\n                        MapData.VisibleLayers.splice(MapData.VisibleLayers.indexOf(existingLayer), 1);\r\n                    }\r\n                    if (existingTheme.VisibleLayers.indexOf(existingLayer) != -1) {\r\n                        existingTheme.VisibleLayers.splice(existingTheme.VisibleLayers.indexOf(existingLayer), 1);\r\n                    }\r\n                }\r\n                existingLayer.enabled = updatedLayer.enabled;\r\n                existingLayer.visible = updatedLayer.visible;\r\n            };\r\n            existingTheme.RecalculateVisibleLayerIds();\r\n        };\r\n        _service.AddNewTheme = function (theme) {\r\n            MapData.Themes.unshift(theme)\r\n\r\n            _.each(theme.AllLayers, function (layer) {\r\n                if (layer.enabled && layer.visible && layer.type === LayerType.LAYER) {\r\n                    console.log(layer.id);\r\n                    theme.VisibleLayers.push(layer);\r\n                    if (theme.Type == ThemeType.ESRI) {\r\n                        MapData.VisibleLayers.push(layer);\r\n                    }\r\n                }\r\n\r\n            });\r\n            theme.RecalculateVisibleLayerIds();\r\n\r\n            switch (theme.Type) {\r\n                case ThemeType.ESRI:\r\n                    theme.MapData = L.esri.dynamicMapLayer({\r\n                        maxZoom: 20,\r\n                        minZoom: 1,\r\n                        url: theme.CleanUrl,\r\n                        opacity: 1,\r\n                        layers: theme.VisibleLayerIds,\r\n                        continuousWorld: true,\r\n                        useCors: true\r\n                    }).addTo(map);\r\n\r\n                    // theme.MapData = L.esri.tiledMapLayer({\r\n                    //     url: theme.CleanUrl,\r\n                    //     layers: theme.VisibleLayerIds,\r\n                    //     useCors: true\r\n                    // }).addTo(map);\r\n                    theme.MapData.on('load', function (e) {\r\n                        // console.log(MapData.Zindex);\r\n                        // console.log('Load Fired for ' + theme.Naam);\r\n                        if (theme.MapData._currentImage) {\r\n                            theme.MapData._currentImage._image.style.zIndex = theme.MapData.ZIndex;\r\n                            console.log('Zindex on ' + theme.Naam + ' set to ' + theme.MapData.ZIndex);\r\n                        }\r\n                    });\r\n                    // theme.MapData.on('loading', function(e) {\r\n                    //     console.log('loading ' + theme.Naam);\r\n                    // });\r\n                    // theme.MapData.on('requeststart', function(obj) {\r\n                    //     MapData.Loading++;\r\n                    //     console.log(MapData.Loading + 'requeststart ' + theme.Naam);\r\n                    //     $rootScope.$apply();\r\n\r\n\r\n                    // });\r\n                    // theme.MapData.on('requestend', function(obj) {\r\n                    //     if (MapData.Loading > 0) {\r\n                    //         MapData.Loading--;\r\n                    //     }\r\n                    //     console.log(MapData.Loading + 'requestend ' + theme.Naam);\r\n                    //     $rootScope.$apply();\r\n\r\n                    // });\r\n                    break;\r\n                case ThemeType.WMS:\r\n                    theme.MapData = L.tileLayer.betterWms(theme.CleanUrl, {\r\n                        maxZoom: 20,\r\n                        minZoom: 1,\r\n                        format: 'image/png',\r\n                        layers: theme.VisibleLayerIds,\r\n                        transparent: true,\r\n                        continuousWorld: true,\r\n                        useCors: true\r\n                    }).addTo(map);\r\n                    // theme.MapData.on('tileloadstart', function(obj) {\r\n                    //     MapData.Loading++;\r\n                    //     console.log(MapData.Loading + 'tileloadstart ' + theme.Naam);\r\n                    //     $rootScope.$apply();\r\n\r\n\r\n                    // });\r\n                    // theme.MapData.on('tileerror', function(obj) {\r\n                    //     // if (MapData.Loading > 0) {\r\n                    //         MapData.Loading--;\r\n                    //     // }\r\n                    //     console.log('!!!!!!!!! ' + MapData.Loading + 'tileerror ' + theme.Naam);\r\n                    //     $rootScope.$apply();\r\n\r\n\r\n                    // });\r\n                    // theme.MapData.on('tileload', function(obj) {\r\n                    //     // if (MapData.Loading > 0) {\r\n                    //         MapData.Loading--;\r\n                    //     // }\r\n                    //     console.log(MapData.Loading + 'tileload ' + theme.Naam);\r\n                    //     $rootScope.$apply();\r\n\r\n                    // });\r\n                    theme.MapData.on('load', function (e) {\r\n                        console.log('LOAD VAN ' + theme.Naam);\r\n                        console.log(theme.MapData);\r\n                        if (theme.MapData._tileContainer.children) {\r\n                            [].slice.call(theme.MapData._tileContainer.childNodes).forEach(imgNode => {\r\n                                imgNode.style.zIndex = theme.MapData.ZIndex;\r\n                            });\r\n                            // theme.MapData._currentImage._image.style.zIndex = theme.MapData.ZIndex;\r\n                            console.log('Zindex on ' + theme.Naam + ' set to ' + theme.MapData.ZIndex);\r\n                        }\r\n                    });\r\n                    break;\r\n                default:\r\n                    console.log('UNKNOW TYPE');\r\n                    break;\r\n            }\r\n\r\n            // _mapService.UpdateThemeVisibleLayers(theme);\r\n\r\n\r\n        };\r\n        _service.DeleteTheme = function (theme) {\r\n            // theme.MapData.removeFrom(map);\r\n            map.removeLayer(theme.MapData); // this one works with ESRI And leaflet\r\n            var themeIndex = MapData.Themes.indexOf(theme);\r\n            if (themeIndex > -1) {\r\n                MapData.Themes.splice(themeIndex, 1);\r\n            }\r\n            theme.VisibleLayers.forEach(visLayer => {\r\n                var visLayerIndex = MapData.VisibleLayers.indexOf(visLayer);\r\n                if (visLayerIndex > -1) {\r\n                    MapData.VisibleLayers.splice(visLayerIndex, 1);\r\n                }\r\n            });\r\n            MapData.CleanSearch();\r\n        };\r\n\r\n\r\n\r\n        return _service;\r\n    };\r\n    module.$inject = ['map', 'ThemeHelper', 'MapData', 'LayerManagementService'];\r\n    module.factory('ThemeService', service);\r\n})();\r\n"]}