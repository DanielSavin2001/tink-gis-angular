'use strict';
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var _ = require('lodash');
var angular = require('angular');
var LayerRAW = (function () {
    function LayerRAW(layerJSON) {
        Object.assign(this, layerJSON);
    }
    return LayerRAW;
}());
var Layer = (function (_super) {
    __extends(Layer, _super);
    function Layer(info, parenttheme) {
        _super.call(this, LayerRAW);
        this.visible = info.defaultVisibility;
        this.enabled = true;
        this.parent = null;
        this.title = info.name;
        this.theme = parenttheme;
        this.displayed = true;
        if (this.parentLayerId === -1 && this.subLayerIds !== null) {
            this.type = LayerType.GROUP;
        }
        else {
            this.type = LayerType.LAYER;
        }
    }
    Layer.prototype.UpdateDisplayed = function (currentScale) {
        if (this.maxScale > 0 || this.minScale > 0) {
            console.log('MinMaxandCurrentScale', this.maxScale, this.minScale, currentScale);
            if (currentScale > this.maxScale && currentScale < this.minScale) {
                this.displayed = true;
            }
            else {
                this.displayed = false;
            }
        }
    };
    ;
    return Layer;
}(LayerRAW));
var Theme = (function () {
    function Theme() {
    }
    Theme.prototype.UpdateDisplayed = function (currentScale) {
        this.AllLayers.forEach(function (layer) {
            layer.UpdateDisplayed(currentScale);
        });
    };
    Theme.prototype.UpdateMap = function () {
        this.RecalculateVisibleLayerIds();
        this.MapData.setLayers(this.VisibleLayerIds);
    };
    ;
    Theme.prototype.RecalculateVisibleLayerIds = function () {
        this.VisibleLayerIds.length = 0;
        this.VisibleLayers.forEach(function (visLayer) {
            this.VisibleLayerIds.push(visLayer.id);
        });
        if (this.VisibleLayerIds.length === 0) {
            this.VisibleLayerIds.push(-1);
        }
    };
    ;
    return Theme;
}());
var ArcGIStheme = (function (_super) {
    __extends(ArcGIStheme, _super);
    function ArcGIStheme(rawdata, themeData) {
        _super.call(this);
        var rawlayers = rawdata.layers;
        this.Naam = rawdata.documentInfo.Title;
        this.name = rawdata.documentInfo.Title;
        this.Description = rawdata.documentInfo.Subject;
        this.Layers = [];
        this.AllLayers = [];
        this.Groups = [];
        this.CleanUrl = themeData.cleanUrl;
        this.Url = themeData.url;
        this.VisibleLayers = [];
        this.VisibleLayerIds = [];
        this.Visible = true;
        this.Added = false;
        this.enabled = true;
        this.Type = ThemeType.ESRI;
        this.status = ThemeStatus.NEW;
        this.MapData = {};
        _.each(rawlayers, function (layerInfo) {
            var layer = new Layer(layerInfo, this);
            this.AllLayers.push(layer);
            if (layer.parentLayerId === -1) {
                if (layer.subLayerIds === null) {
                    this.Layers.push(layer);
                }
                else {
                    this.Groups.push(layer);
                }
            }
        });
        _.each(this.Groups, function (layerGroup) {
            if (layerGroup.subLayerIds !== null) {
                layerGroup.Layers = [];
                _.each(rawlayers, function (rawlayer) {
                    if (layerGroup.id === rawlayer.parentLayerId) {
                        rawlayer.parent = layerGroup;
                        layerGroup.Layers.push(rawlayer);
                    }
                });
            }
        });
        this.RecalculateVisibleLayerIds();
    }
    return ArcGIStheme;
}(Theme));
(function () {
    var module = angular.module('tink.gis');
    var service = function () {
        var themeHelper = {};
        themeHelper.createThemeFromJson = function (rawdata, themeData) {
            var theme = new ArcGIStheme(rawdata, themeData);
            return theme;
        };
        return themeHelper;
    };
    module.factory('ThemeHelper', service);
})();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXJjR0lTdGhlbWUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJBcmNHSVN0aGVtZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxZQUFZLENBQUM7Ozs7OztBQUNiLElBQVksQ0FBQyxXQUFNLFFBQVEsQ0FBQyxDQUFBO0FBQzVCLElBQVksT0FBTyxXQUFNLFNBQVMsQ0FBQyxDQUFBO0FBQ25DO0lBUUksa0JBQVksU0FBYztRQUN0QixNQUFNLENBQUMsTUFBTSxDQUFnQixJQUFJLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUNMLGVBQUM7QUFBRCxDQUFDLEFBWEQsSUFXQztBQUNEO0lBQW9CLHlCQUFRO0lBVXhCLGVBQVksSUFBYyxFQUFFLFdBQWtCO1FBQzFDLGtCQUFNLFFBQVEsQ0FBQyxDQUFDO1FBRWhCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDO1FBQ3RDLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksQ0FBQyxLQUFLLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztRQUN2QixJQUFJLENBQUMsS0FBSyxHQUFHLFdBQVcsQ0FBQztRQUN6QixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQztRQUN0QixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxXQUFXLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN6RCxJQUFJLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxLQUFLLENBQUM7UUFDaEMsQ0FBQztRQUNELElBQUksQ0FBQyxDQUFDO1lBQ0YsSUFBSSxDQUFDLElBQUksR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDO1FBQ2hDLENBQUM7SUFDTCxDQUFDO0lBQ0QsK0JBQWUsR0FBZixVQUFnQixZQUFZO1FBQ3hCLEVBQUUsQ0FB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QUFDO29CQUNyQyxDQUFDO2dCQUNMLENBQUMsQ0FBQyxDQUFDO1lBQ1AsQ0FBQztRQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0gsSUFBSSxDQUFDLDBCQUEwQixFQUFFLENBQUM7SUFDdEMsQ0FBQztJQUdMLGtCQUFDO0FBQUQsQ0FBQyxBQTlDRCxDQUEwQixLQUFLLEdBOEM5QjtBQUNELENBQUM7SUFDRyxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBQyxDQUFDO0lBQ3hDLElBQUksT0FBTyxHQUFHO1FBQ1YsSUFBSSxXQUFXLEdBQVEsRUFBRSxDQUFDO1FBQzFCLFdBQVcsQ0FBQyxtQkFBbUIsR0FBRyxVQUFVLE9BQU8sRUFBRSxTQUFTO1lBQzFELElBQUksS0FBSyxHQUFHLElBQUksV0FBVyxDQUFDLE9BQU8sRUFBRSxTQUFTLENBQUMsQ0FBQTtZQUMvQyxNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2pCLENBQUMsQ0FBQztRQUNGLE1BQU0sQ0FBQyxXQUFXLENBQUM7SUFDdkIsQ0FBQyxDQUFDO0lBQ0YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxhQUFhLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDM0MsQ0FBQyxDQUFDLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcclxuaW1wb3J0ICogYXMgXyBmcm9tICdsb2Rhc2gnO1xyXG5pbXBvcnQgKiBhcyBhbmd1bGFyIGZyb20gJ2FuZ3VsYXInO1xyXG5jbGFzcyBMYXllclJBVyB7XHJcbiAgICBpZDogbnVtYmVyO1xyXG4gICAgbmFtZTogc3RyaW5nO1xyXG4gICAgcGFyZW50TGF5ZXJJZDogbnVtYmVyO1xyXG4gICAgZGVmYXVsdFZpc2liaWxpdHk6IGJvb2xlYW47XHJcbiAgICBzdWJMYXllcklkczogbnVtYmVyW107XHJcbiAgICBtaW5TY2FsZTogbnVtYmVyO1xyXG4gICAgbWF4U2NhbGU6IG51bWJlcjtcclxuICAgIGNvbnN0cnVjdG9yKGxheWVySlNPTjogYW55KSB7XHJcbiAgICAgICAgT2JqZWN0LmFzc2lnbjxMYXllclJBVywgYW55Pih0aGlzLCBsYXllckpTT04pO1xyXG4gICAgfVxyXG59XHJcbmNsYXNzIExheWVyIGV4dGVuZHMgTGF5ZXJSQVcge1xyXG4gICAgdmlzaWJsZTogYm9vbGVhbjtcclxuICAgIGVuYWJsZWQ6IGJvb2xlYW47XHJcbiAgICBwYXJlbnQ6IGFueTtcclxuICAgIHRoZW1lOiBUaGVtZTtcclxuICAgIHRpdGxlOiBzdHJpbmc7XHJcbiAgICBkaXNwbGF5ZWQ6IGJvb2xlYW47XHJcbiAgICB0eXBlOiBudW1iZXI7XHJcbiAgICBMYXllcnM6IEFycmF5PExheWVyPjtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihpbmZvOiBMYXllclJBVywgcGFyZW50dGhlbWU6IFRoZW1lKSB7XHJcbiAgICAgICAgc3VwZXIoTGF5ZXJSQVcpO1xyXG4gICAgICAgIC8vb1xyXG4gICAgICAgIHRoaXMudmlzaWJsZSA9IGluZm8uZGVmYXVsdFZpc2liaWxpdHk7XHJcbiAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTtcclxuICAgICAgICB0aGlzLnBhcmVudCA9IG51bGw7XHJcbiAgICAgICAgdGhpcy50aXRsZSA9IGluZm8ubmFtZTtcclxuICAgICAgICB0aGlzLnRoZW1lID0gcGFyZW50dGhlbWU7XHJcbiAgICAgICAgdGhpcy5kaXNwbGF5ZWQgPSB0cnVlO1xyXG4gICAgICAgIGlmICh0aGlzLnBhcmVudExheWVySWQgPT09IC0xICYmIHRoaXMuc3ViTGF5ZXJJZHMgIT09IG51bGwpIHtcclxuICAgICAgICAgICAgdGhpcy50eXBlID0gTGF5ZXJUeXBlLkdST1VQO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy50eXBlID0gTGF5ZXJUeXBlLkxBWUVSO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIFVwZGF0ZURpc3BsYXllZChjdXJyZW50U2NhbGUpIHtcclxuICAgICAgICBpZiAodGhpcy5tYXhTY2FsZSA+IDAgfHwgdGhpcy5taW5TY2FsZSA+IDApIHtcclxuICAgICAgICAgICAgY29uc29sZS5sb2coJ01pbk1heGFuZEN1cnJlbnRTY2FsZScsIHRoaXMubWF4U2NhbGUsIHRoaXMubWluU2NhbGUsIGN1cnJlbnRTY2FsZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50U2NhbGUgPiB0aGlzLm1heFNjYWxlICYmIGN1cnJlbnRTY2FsZSA8IHRoaXMubWluU2NhbGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheWVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuZGlzcGxheWVkID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcbmFic3RyYWN0IGNsYXNzIFRoZW1lIHtcclxuICAgIE5hYW06IHN0cmluZztcclxuICAgIG5hbWU6IHN0cmluZztcclxuICAgIERlc2NyaXB0aW9uOiBzdHJpbmc7XHJcbiAgICBDbGVhblVybDogc3RyaW5nO1xyXG4gICAgVXJsOiBzdHJpbmc7XHJcblxyXG4gICAgVmlzaWJsZTogYm9vbGVhbjtcclxuICAgIEFkZGVkOiBib29sZWFuO1xyXG4gICAgZW5hYmxlZDogYm9vbGVhbjtcclxuXHJcbiAgICBUeXBlOiBzdHJpbmc7XHJcbiAgICBzdGF0dXM6IG51bWJlcjtcclxuXHJcbiAgICBWaXNpYmxlTGF5ZXJJZHM6IEFycmF5PG51bWJlcj47XHJcbiAgICBMYXllcnM6IEFycmF5PExheWVyPjtcclxuICAgIFZpc2libGVMYXllcnM6IEFycmF5PExheWVyPjtcclxuICAgIEFsbExheWVyczogQXJyYXk8TGF5ZXI+O1xyXG4gICAgR3JvdXBzOiBBcnJheTxMYXllcj47XHJcblxyXG4gICAgTWFwRGF0YTogYW55O1xyXG5cclxuICAgIFVwZGF0ZURpc3BsYXllZChjdXJyZW50U2NhbGUpIHtcclxuICAgICAgICB0aGlzLkFsbExheWVycy5mb3JFYWNoKGZ1bmN0aW9uIChsYXllcikge1xyXG4gICAgICAgICAgICBsYXllci5VcGRhdGVEaXNwbGF5ZWQoY3VycmVudFNjYWxlKTtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIFVwZGF0ZU1hcCgpIHtcclxuICAgICAgICB0aGlzLlJlY2FsY3VsYXRlVmlzaWJsZUxheWVySWRzKCk7XHJcbiAgICAgICAgdGhpcy5NYXBEYXRhLnNldExheWVycyh0aGlzLlZpc2libGVMYXllcklkcyk7XHJcbiAgICB9O1xyXG4gICAgUmVjYWxjdWxhdGVWaXNpYmxlTGF5ZXJJZHMoKSB7XHJcbiAgICAgICAgdGhpcy5WaXNpYmxlTGF5ZXJJZHMubGVuZ3RoID0gMDtcclxuICAgICAgICB0aGlzLlZpc2libGVMYXllcnMuZm9yRWFjaChmdW5jdGlvbiAodmlzTGF5ZXIpIHtcclxuICAgICAgICAgICAgdGhpcy5WaXNpYmxlTGF5ZXJJZHMucHVzaCh2aXNMYXllci5pZCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKHRoaXMuVmlzaWJsZUxheWVySWRzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLlZpc2libGVMYXllcklkcy5wdXNoKC0xKTsgLy9hbHMgd2UgbmlldCBkb2VuIGRhbiB6b2VrdCBoaWogb3AgYWxsZSBsYWdlbiFcclxuICAgICAgICB9XHJcbiAgICB9O1xyXG59XHJcblxyXG5jbGFzcyBBcmNHSVN0aGVtZSBleHRlbmRzIFRoZW1lIHtcclxuICAgIGNvbnN0cnVjdG9yKHJhd2RhdGE6IGFueSwgdGhlbWVEYXRhOiBhbnkpIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHZhciByYXdsYXllcnMgPSByYXdkYXRhLmxheWVycztcclxuICAgICAgICB0aGlzLk5hYW0gPSByYXdkYXRhLmRvY3VtZW50SW5mby5UaXRsZTtcclxuICAgICAgICB0aGlzLm5hbWUgPSByYXdkYXRhLmRvY3VtZW50SW5mby5UaXRsZTtcclxuICAgICAgICB0aGlzLkRlc2NyaXB0aW9uID0gcmF3ZGF0YS5kb2N1bWVudEluZm8uU3ViamVjdDtcclxuICAgICAgICB0aGlzLkxheWVycyA9IFtdOyAvLyBkZSBsYXllcnMgZGlyZWN0IG9uZGVyIGhldCB0aGVtZSB6b25kZXIgc3VibGF5ZXJzXHJcbiAgICAgICAgdGhpcy5BbGxMYXllcnMgPSBbXTsgLy8gYWxsZSBMYXllcnMgZGllIGhpaiBoZWVmdCBpbmNsdWRpbmcgc3ViZ3JvdXBsYXllcnNcclxuICAgICAgICB0aGlzLkdyb3VwcyA9IFtdOyAvLyBsYXllcmdyb3VwcyBkaWUgbm9nIGVlbnMgbGF5ZXJzIHplbGYgaGViYmVuXHJcbiAgICAgICAgdGhpcy5DbGVhblVybCA9IHRoZW1lRGF0YS5jbGVhblVybDtcclxuICAgICAgICB0aGlzLlVybCA9IHRoZW1lRGF0YS51cmw7XHJcbiAgICAgICAgdGhpcy5WaXNpYmxlTGF5ZXJzID0gW107XHJcbiAgICAgICAgdGhpcy5WaXNpYmxlTGF5ZXJJZHMgPSBbXTtcclxuICAgICAgICB0aGlzLlZpc2libGUgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuQWRkZWQgPSBmYWxzZTtcclxuICAgICAgICB0aGlzLmVuYWJsZWQgPSB0cnVlO1xyXG4gICAgICAgIHRoaXMuVHlwZSA9IFRoZW1lVHlwZS5FU1JJO1xyXG4gICAgICAgIHRoaXMuc3RhdHVzID0gVGhlbWVTdGF0dXMuTkVXO1xyXG4gICAgICAgIHRoaXMuTWFwRGF0YSA9IHt9O1xyXG4gICAgICAgIF8uZWFjaChyYXdsYXllcnMsIGZ1bmN0aW9uIChsYXllckluZm86IExheWVyUkFXKSB7XHJcbiAgICAgICAgICAgIGxldCBsYXllciA9IG5ldyBMYXllcihsYXllckluZm8sIHRoaXMpO1xyXG4gICAgICAgICAgICB0aGlzLkFsbExheWVycy5wdXNoKGxheWVyKTtcclxuICAgICAgICAgICAgaWYgKGxheWVyLnBhcmVudExheWVySWQgPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAobGF5ZXIuc3ViTGF5ZXJJZHMgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLkxheWVycy5wdXNoKGxheWVyKTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5Hcm91cHMucHVzaChsYXllcik7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTtcclxuICAgICAgICBfLmVhY2godGhpcy5Hcm91cHMsIGZ1bmN0aW9uIChsYXllckdyb3VwOiBMYXllcikge1xyXG4gICAgICAgICAgICBpZiAobGF5ZXJHcm91cC5zdWJMYXllcklkcyAhPT0gbnVsbCkge1xyXG4gICAgICAgICAgICAgICAgbGF5ZXJHcm91cC5MYXllcnMgPSBbXTtcclxuICAgICAgICAgICAgICAgIF8uZWFjaChyYXdsYXllcnMsIGZ1bmN0aW9uIChyYXdsYXllcikge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXllckdyb3VwLmlkID09PSByYXdsYXllci5wYXJlbnRMYXllcklkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJhd2xheWVyLnBhcmVudCA9IGxheWVyR3JvdXA7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxheWVyR3JvdXAuTGF5ZXJzLnB1c2gocmF3bGF5ZXIpO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5SZWNhbGN1bGF0ZVZpc2libGVMYXllcklkcygpO1xyXG4gICAgfVxyXG5cclxuXHJcbn1cclxuKGZ1bmN0aW9uICgpIHtcclxuICAgIHZhciBtb2R1bGUgPSBhbmd1bGFyLm1vZHVsZSgndGluay5naXMnKTtcclxuICAgIHZhciBzZXJ2aWNlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHZhciB0aGVtZUhlbHBlcjogYW55ID0ge307XHJcbiAgICAgICAgdGhlbWVIZWxwZXIuY3JlYXRlVGhlbWVGcm9tSnNvbiA9IGZ1bmN0aW9uIChyYXdkYXRhLCB0aGVtZURhdGEpIHtcclxuICAgICAgICAgICAgbGV0IHRoZW1lID0gbmV3IEFyY0dJU3RoZW1lKHJhd2RhdGEsIHRoZW1lRGF0YSlcclxuICAgICAgICAgICAgcmV0dXJuIHRoZW1lO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgcmV0dXJuIHRoZW1lSGVscGVyO1xyXG4gICAgfTtcclxuICAgIG1vZHVsZS5mYWN0b3J5KCdUaGVtZUhlbHBlcicsIHNlcnZpY2UpO1xyXG59KSgpO1xyXG4iXX0=